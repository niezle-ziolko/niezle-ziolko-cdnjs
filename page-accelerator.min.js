"use strict";const lwipify=require("lwipify"),gmTools=require("gm-tools"),CbBuffer=require("cb-buffer"),Err=require("err"),Pixel=require("pixel-class"),noop=require("noop6");module.exports=class ImageParser{constructor(source,options){this.source=source;this.options=options;this.parser=null;this.gm=false;this.lwip=false;this.img=null;this._parseBuffer=new CbBuffer();this.__lwip=true}parse(cb){if(this._parseBuffer.check(cb)){return}lwipify(this.source,this.options,(err,data,options)=>{if(err){this[this.parser="gm"]=true;this.img=gmTools(options.source);return this.img.parse((err,data)=>{if(!err){this._imgBuffer=data[0]}return this._parseBuffer.done(err,this,data)});}this.img=data;this[this.parser="lwip"]=true;this._parseBuffer.done(null,this,data)})}_checkParsed(){if(!this.img){throw new Err("Parse the image first by using the parse method.","IMAGE_NOT_PARSED")}}width(){this._checkParsed();return this.img.width()}height(){this._checkParsed();return this.img.height()}getPixel(x,y){this._checkParsed();let args=[x,y];this.gm?args.push(this._imgBuffer):"";return new Pixel(this.img.getPixel.apply(this.img,args))}pixels(){this._checkParsed();let pixels=[];let size={height:this.height(),width:this.width()};for(let y=0;y<size.height;y+=1){for(let x=0;x<size.width;x+=1){pixels.push(this.getPixel(x,y))}}return pixels}resize(width,height,cb){this._checkParsed();if(this.gm){this.img.gm.resize(width,height,"!");this.img.gm.toBuffer("PNG",(err,data)=>{let resized=new ImageParser(data,this.options);resized.parse(err=>cb(err,resized))})}else{this.img.resize(width,height,(err,img)=>{let resized=new ImageParser(img,this.options);resized.parse(err=>cb(err,resized))})}}crop(width,height,x,y,cb){this._checkParsed();if(this.gm){this.img.gm.crop(width,height,x,y);this.img.gm.toBuffer("PNG",(err,data)=>{let resized=new ImageParser(data,this.options);resized.parse(err=>cb(err,resized))})}else{throw new Error("Not yet supported.")}}save(filePath,cb){cb=cb||noop;this._checkParsed();if(this.gm){this.img.gm.write(filePath,cb)}else{this.img.writeFile(filePath,cb)}}};
